# Анализ архитектуры и план рефакторинга

## Текущее состояние архитектуры

### Что работает хорошо

1. **Разделение на слои**: Проект следует Clean Architecture с разделением на domain, ports, adapters
2. **Порты определены**: Есть интерфейсы для MetadataRepository, MediaStore, MediaUploader
3. **Адаптеры изолированы**: Реализации адаптеров отделены от домена

### Проблемы и несоответствия требованиям

#### 1. Домен оперирует конкретными терминами

**Проблема:**
- `VideoTask.video_file_path: str` - это конкретный путь к файлу, а не абстрактный референс
- Домен напрямую использует `task.video_file_path` вместо медиа-референса
- В `domain/services.py` строка 120: `if not self.media_store.exists(task.video_file_path)` - домен знает о "путях к файлам"

**Требование:** Домен должен оперировать только сигналами, референсами, метаданными, без конкретных терминов (файл, таблица, строка БД)

#### 2. Неправильная последовательность операций

**Текущий порядок (domain/services.py:99-184):**
1. Проверка существования медиа (`media_store.exists`)
2. Переход медиа в IN_PROGRESS (`media_store.transition`)
3. Обновление статуса задачи в metadata_repo на UPLOADING
4. Загрузка через media_uploader

**Требуемый порядок:**
1. Домен получает задачу из metadata_repo
2. Домен отправляет сигнал в metadata_repo: "задача IN_PROGRESS"
3. Домен запрашивает подтверждение медиа-референса в media_store
4. Если медиа подтверждено - отправляет сигнал в media_store: "референс IN_PROGRESS"
5. Домен отправляет метаданные + подтвержденный референс в media_uploader
6. После подтверждения от uploader - отправляет сигналы в остальные адаптеры

#### 3. Отсутствует подтверждение медиа-референса

**Проблема:**
- Нет явного шага подтверждения медиа-референса перед переходом в IN_PROGRESS
- Домен не проверяет, что медиа-референс валиден и доступен

**Требование:** Перед пометкой задачи IN_PROGRESS нужно подтвердить медиа-референс в media_store

#### 4. Неправильная обработка ошибок

**Проблема:**
- При ошибке домен сразу помечает задачу FAILED
- Нет разделения на краткое описание (для metadata_repo) и подробное (для логов)
- Медиа-стор не игнорирует сигнал FAILED (как требуется)

**Требование:** 
- Подробная информация об ошибке - в лог (каждый модуль сам)
- Краткая информация - в домен, который обрабатывает ошибки
- При FAILED медиа-стор должен игнорировать сигнал (не откатывать переход)

#### 5. Медиа-стор не преобразует референсы

**Проблема:**
- YouTube адаптер сам вызывает `media_store.get_path(media_ref)` для получения пути
- Это правильно, но нужно убедиться, что это единственный способ получения конкретного формата

**Требование:** Медиа-стор должен преобразовывать свои референсы в нужный формат (путь к файлу) по запросу

#### 6. Отсутствует статус IN_PROGRESS для задач

**Проблема:**
- В `TaskStatus` нет статуса `IN_PROGRESS`
- Есть `UPLOADING`, но нет промежуточного статуса для "задача принята в обработку"

**Требование:** Нужен статус IN_PROGRESS для задач

#### 7. Прямое взаимодействие адаптеров

**Проблема:**
- YouTube адаптер получает `media_store` в конструкторе и использует его напрямую
- Это может быть допустимо (как указано в требованиях), но нужно проверить

**Требование:** Адаптеры могут взаимодействовать напрямую, если это не требует доменной логики (например, преобразование референса в путь)

## План рефакторинга

### Этап 1: Изоляция домена от конкретных терминов

1. **Переименовать `video_file_path` в `media_reference`** в `VideoTask`
   - Это абстрактный референс, а не конкретный путь
   - Адаптеры будут знать, как его интерпретировать

2. **Обновить `GoogleSheetsMetadataRepository`**
   - При чтении из таблицы сохранять значение как `media_reference` (не интерпретируя как путь)
   - При записи обратно - просто сохранять референс

3. **Обновить `PublishService`**
   - Использовать `task.media_reference` вместо `task.video_file_path`
   - Не делать предположений о формате референса

### Этап 2: Реализация правильной последовательности операций

1. **Добавить статус `IN_PROGRESS` в `TaskStatus`**

2. **Изменить логику в `PublishService.publish_task()`:**
   ```
   - Получить задачу (уже есть)
   - Отправить сигнал в metadata_repo: "задача IN_PROGRESS"
   - Запросить подтверждение медиа-референса в media_store
   - Если подтверждено - отправить сигнал в media_store: "референс IN_PROGRESS"
   - Отправить метаданные + референс в media_uploader
   - После подтверждения от uploader - обновить статусы
   ```

3. **Добавить метод подтверждения в `MediaStore`:**
   ```python
   def verify_reference(self, ref: str) -> bool:
       """Проверить, что медиа-референс валиден и доступен."""
   ```

4. **Добавить метод сигнала в `MediaStore`:**
   ```python
   def mark_in_progress(self, ref: str) -> str:
       """Пометить медиа-референс как IN_PROGRESS. Возвращает новый референс."""
   ```

### Этап 3: Улучшение обработки ошибок

1. **Структурировать ошибки:**
   - Каждый адаптер логирует подробности сам
   - Возвращает краткое описание через исключения/результаты

2. **Обработка FAILED:**
   - Медиа-стор игнорирует сигнал FAILED (не откатывает переход)
   - Metadata_repo помечает задачу FAILED с кратким описанием

### Этап 4: Уточнение взаимодействия адаптеров

1. **Проверить взаимодействие YouTube адаптера с MediaStore:**
   - Текущая реализация (YouTube адаптер вызывает `media_store.get_path()`) соответствует требованиям
   - Медиа-стор преобразует референс в путь по запросу

## Вопросы для уточнения

1. **Статус IN_PROGRESS для задач:**
   - Нужен ли отдельный статус `IN_PROGRESS` для задач, или достаточно `UPLOADING`?
   - Или `IN_PROGRESS` - это промежуточный статус между `READY` и `UPLOADING`?

2. **Подтверждение медиа-референса:**
   - Должен ли `verify_reference` только проверять существование, или также валидировать доступность?
   - Нужно ли возвращать какую-то информацию о медиа при подтверждении?

3. **Сигналы в адаптеры:**
   - Должны ли методы типа `mark_in_progress` быть синхронными или асинхронными?
   - Нужна ли поддержка отката (rollback) при ошибках?

4. **Обработка ошибок при подтверждении:**
   - Если медиа-референс не подтвержден - сразу FAILED или есть retry логика?
   - Что делать, если медиа-референс подтвержден, но переход в IN_PROGRESS не удался?

5. **Метаданные задачи:**
   - Должен ли `media_reference` быть обязательным полем в `VideoTask`?
   - Нужно ли хранить исходный референс и обновленный (после перехода в IN_PROGRESS)?
